@startuml

start
:Consumer sets 'Formed Proposal' state in exchange;
:Consumer sends fully formed terms and conditions to Producer;
if (Producer agrees to the terms) then (yes)
    :Producer creates SHA3 hash of terms;
    :Producer signs hash with ethereum account;
    :Producer sets 'Agree to Proposal' state in exchange;
    :Producer responds to Consumer with signature;
    :Consumer acknowledges response;
    :Consumer sets 'Producer agreed' state in exchange;
    :Consumer writes agreement to the blockchain;

    fork
        while (Producer sees agreement in blockchain?) is (no)
            if (timeout waiting for blockchain write) then (yes)
                :Producer cancels agreement;
                :Producer deletes agreement from exchange;
                stop
            else (no)
                :Check for agreement on blockchain;
            endif
        endwhile (yes)
        :Producer sets 'Finalized agreement' state in exchange;

    fork again
        while (Consumer sees agreement in blockchain?) is (no)
            if (timeout waiting for blockchain write) then (yes)
                :Consumer cancels agreement;
                :Consumer deletes agreement from exchange;
                stop
            else (no)
                :Check for agreement on blockchain;
            endif
        endwhile (yes)
        :Consumer sets 'Finalized agreement' state in exchange;

    fork again
        :Producer downloads workload containers from bit torrent;
        :Start the workload containers;

    fork again
        while (Consumer sees workload data yet?) is (no)
            if (timeout waiting for data receipt) then (yes)
                :Consumer cancels agreement;
                :Consumer deletes agreement from exchange;
                stop
            else (no)
                :Check for data receipt;
            endif
        endwhile (yes)
        :Consumer tells Producer that it received data;
        :Producer acknowledges;
        :Consumer sends Metering Notification to Producer;
    end fork

else (no)
    :Producer returns negative response to Consumer;
    :Consumer acknowledges response;
    :Consumer deletes agreement from exchange;
endif
stop
@enduml